---
import { SITE } from 'src/config'
import Button from '@components/Button.astro'
import Heading from '@components/Heading.astro'
import Layout from '@layouts/Layout.astro'
import RadioMenu from '@components/RadioMenu.astro'
import TextField from '@components/TextField.astro'
---

<Layout title={SITE.title + ': Macros'}>
  <Heading level="h1">Low Carb Macros</Heading>
  <p>Carbs are set to 50g for all cases</p>
  <div class="flex gap-8 flex-col sm:flex-row">
    <form id="macros" class="flex flex-col gap-4">
      <TextField label="height (inches)" name="height" value="71" />
      <TextField label="weight (lbs)" name="weight" value="195" />
      <TextField label="age" name="age" value="43" />
      <RadioMenu
        name="sex"
        label="sex"
        value="male"
        options={[
          { name: 'male', value: 'male' },
          { name: 'female', value: 'female' },
        ]}
      />

      <RadioMenu
        name="phase"
        label="activity level"
        value="maintain"
        options={[
          { name: 'maintain', value: 'maintain' },
          { name: 'bulk', value: 'bulk' },
          { name: 'cut', value: 'cut' },
        ]}
      />

      <RadioMenu
        name="activityLevel"
        label="Activity Level"
        value="1.375"
        options={[
          { name: 'sedentary', value: '1.2' },
          { name: 'light', value: '1.375' },
          { name: 'moderate', value: '1.55' },
          { name: 'heavy', value: '1.725' },
          { name: 'extreme', value: '1.9' },
        ]}
      >
        <div>
          Sedentary is nadda.
          <br />
          Light is 1-3 workouts a week.
          <br />
          Moderate 4-5 workouts a week.
          <br />
          Heavy 6-7 workouts a week. <br />
          Extreme 2x a day many days a week.
        </div>
      </RadioMenu>
      <Button type="submit" class="mt-4">Calculate</Button>
    </form>

    <div id="results"></div>
  </div>
</Layout>

<script>
  import { atom } from 'nanostores'
  import { sentencecase } from 'stringcase'

  const getRestingMetabolicRate = (isMale, heightIn, weightLbs, ageYears) => {
    const weightKg = weightLbs / 2.205
    const heightCm = heightIn * 2.54
    return isMale
      ? 10 * weightKg + 6.25 * heightCm - 5 * ageYears + 5
      : 10 * weightKg + 6.25 * heightCm - 5 * ageYears - 161
  }

  const getCalories = (rmr, activityLevel) => Math.round(rmr * activityLevel)

  const getMacros = (weightLbs, rmr, phase, activityLevel) => {
    const activityAdjustedCals = rmr * activityLevel
    const weightInKg = weightLbs / 2.205
    const carbs = 50
    let protein
    let calories

    switch (phase) {
      case 'bulk': {
        calories = activityAdjustedCals * 1.2
        protein = weightInKg * 2
        break
      }
      case 'cut': {
        calories = activityAdjustedCals * 0.8
        protein = weightInKg * 1.4
        break
      }
      default: {
        calories = activityAdjustedCals * 1
        protein = weightInKg * 1.7
      }
    }

    const proteinCal = Math.round(protein * 4)
    const carbCal = Math.round(carbs * 4)
    const fatCal = Math.round(calories - carbCal - proteinCal)

    return {
      cal: Math.round(calories),
      carbCal,
      carbGram: carbs,
      fatCal,
      fatGram: Math.round(fatCal / 9),
      proteinCal,
      proteinGram: Math.round(protein),
    }
  }

  const activityLevels = [
    { name: 'sedentary', value: '1.2' },
    { name: 'light', value: '1.375' },
    { name: 'moderate', value: '1.55' },
    { name: 'heavy', value: '1.725' },
    { name: 'extreme', value: '1.9' },
  ]

  const state = atom({})
  const inputs = document.querySelectorAll('#macros input')
  const form = document.getElementById('macros')
  const results = document.getElementById('results')

  /*
    inputs.forEach((input) => {
      input.addEventListener('change', (e) => {
        state.set({ ...state.get(), [e.target.name]: e.target.value })
      })
    })
  */

  form.onsubmit = (e) => {
    e.preventDefault()

    inputs.forEach((input) => {
      if (input.type === 'radio' || input.type === 'checkbox') {
        if (input.checked) {
          state.set({ ...state.get(), [input.name]: input.value })
        }
      } else {
        state.set({ ...state.get(), [input.name]: input.value })
      }
    })

    const formState = state.get()
    // @ts-ignore
    const { sex, height, weight, age, activityLevel, phase } = formState
    const rmr = getRestingMetabolicRate(sex === 'male', height, weight, age)
    const macros = getMacros(weight, rmr, phase, activityLevel)
    const htmlString = Object.entries(macros)
      .map(
        ([key, value]) =>
          `<div class="flex gap-4"><dt>${sentencecase(
            key,
          )}:</dt><dd>${value}</dd></div>`,
      )
      .join('')

    const levelName = activityLevels.find(
      (level) => level.value === activityLevel,
    )

    results.innerHTML = `
    <h3>Goal: ${phase}<br />Level: ${levelName.name}</h3>
    <dl>${htmlString}</dl>`
  }
</script>
